# 串口用法（基于STC单片机）

#### 串口控制寄存器==SCON==
D7|D6|D5|D4|D3|D2|D1|D0
---|---|---|---|---|---|---|---
SM0|SM1|SM2|REN|TB8|RB8|TI|RI

- ##### SM0、SM1:串口工作方式控制位

SM0|SM1|工作方式|说明|波特率
---|---|---|---|---
0|0|0|同步移位寄存器|F(OSC)/12
0|1|1|10位异步收发|由定时器控制
1|0|2|11位异步收发|F(OSC)/32或F(OSC)/64
1|1|3|11位异步收发|由定时器控制

- SM2:多机通信控制位（方式2、3）当SM2为1时，只有接收到第9位（RB8）为1，RI才置位；SM2为0时，接收到单个字节RI就置位
- REN：串口接收允许位。为1即允许串口接收，为0则关闭串口接收
- TB8:方式2、3时，为发送的第9位数据，也可以奇偶校验位
- RB8:方式2、3时，为接收到的第9位数据；方式1时，为接收到的停止位
- TI:发送中断标志，必须软件清零
- RI:接收中断标志，必须软件清零

#### 电源控制寄存器==PCON==

D7|D6|D5|D4|D3|D2|D1|D0
---|---|---|---|---|---|---|---
SMOD|-|-|-|GF1|GF0|PD|IDL

SMOD:串口波特率加倍位


模式\方式|方式 1、3 |方式 2
---|---|---
SMOD=1 |波特率=定时器1溢出率/16|波特率=F(osc)/32
SMOD=0|波特率=定时器1溢出率/32|波特率=F(osc)/62

#### 波特率计算公式

T/C2:波特率=晶振频率/[2×16×(65536-t)]
若结果为：t=0xFFD9;则RCAP2H=0xFF,RCAP2L=0xD9;

T/C1:波特率=2^mod/32*T/C1溢出率

T/C1溢出率=晶振频率/(12*(256-TH1))
必须采用方式2，即8位自动重载




#### 采用T/C1定时器作为波特率发生器时钟
```
#include<STC89C5xRC.H>
void delay()
{
	unsigned char i,j;
	for(i=0;i<255;i++)
		for(j=0;j<255;j++);
	for(i=0;i<255;i++)
		for(j=0;j<255;j++);

}
void init()//波特率设定1200，晶振12MHz,波特率高会接收错误
{
	TH1=TL1=0xCB;
	TMOD=0x20;
	PCON=0x80;
	SCON=0x40;//0100 0000
	TR1=1;

}
void send(unsigned char byte)
{
	SBUF=byte;
	while(TI==0);
	TI=0;
}
int main()
{
	unsigned char i=0;
	init();
	while(1)
	{
		send(i);
		delay();
		i++;
		if(i>=255)
		{
			i=0;
		}
	}
	return 0;	
}

```


```
#include "stc.h"           //加载"stc.h"头文件
/****************************************
*函数名称:Delay
*输    入:无
*输    出:无
*功    能:延时一小段时间 
******************************************/ 
void Delay(void)           //定义Delay函数,延时500ms
{
	unsigned char i,j;     //声明变量i,j

	for(i=0;i<255;i++)     //进行循环操作,以达到延时的效果
		for(j=0;j<255;j++);

	for(i=0;i<255;i++)	   //进行循环操作,以达到延时的效果
		for(j=0;j<255;j++);

	for(i=0;i<255;i++)     //进行循环操作,以达到延时的效果
		for(j=0;j<140;j++);
}
/****************************************
*函数名称:UARTInit
*输    入:无
*输    出:无
*功    能:串口初始化
******************************************/
void UARTInit(void)        //定义串口初始化函数
{
    SCON =0x40;             //8位数据位
	T2CON=0x34;             //由T/C2作为波特率发生器 00110100
	RCAP2L=0xD9;            //波特率为9600的低8位
	RCAP2H=0xFF;            //波特率为9600的高8位
}
/****************************************
*函数名称:UARTSendByte
*输    入:byte 要发送的字节
*输    出:无
*功    能:串口发送单个字节
******************************************/
void UARTSendByte(unsigned char byte)
{
	SBUF=byte;              //缓冲区装载要发送的字节
	while(TI==0);          //等待发送完毕,TI标志位会置1
	TI=0;                    //清零发送中断标志位
}
/****************************************
*函数名称:main
*输    入:无
*输    出:无
*功    能:函数主体
******************************************/
void main(void)            
{
	unsigned char i=0;    //声明变量i

	UARTInit();            //串口初始化

	while(1)                //进入死循环
	{
		UARTSendByte(i);  //串口发送单字节数据
		Delay();            //延时500ms
		i++;                 //i自加1
		if(i>255)i=0;      //若i>255,i=0
	}
}


```
